name: Push Weight-Loss-Trends

on:
  push:
    paths:
      - Weight-Loss-Trends/**
      - .github/workflows/weight-loss-trends.yml
      - Dockerfile

jobs:
  Deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Cache 1
        id: cache-rlib-local
        uses: actions/cache@v3
        with:
          path: /usr/lib/R
          key: ${{ runner.os }}-rlib-local

      - name: Cache 2
        id: cache-rlib
        uses: actions/cache@v3
        with:
          path: /usr/local/lib/R
          key: ${{ runner.os }}-rlib

        
      - run: sudo apt install libcurl4-openssl-dev

      - run: sudo chmod 777 -R /usr/local/lib/R
      - run: sudo chmod 777 -R /usr/lib/R

      - run: Rscript -e "install.packages('rsconnect', repos = 'https://packagemanager.posit.co/cran/__linux__/jammy/latest')"

      - run: Rscript -e "library(rsconnect)"

      # - name: Setup Buildx
      #   uses: docker/setup-buildx-action@v2
      
      # - name: Build
      #   uses: docker/build-push-action@v4
      #   with:
      #     context: .
      #     push: false
      #     load: true
      #     tags: shiny-push:latest
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      # - name: Test rsconnect
      #   if: github.ref != 'refs/heads/main'
      #   run: >
      #     docker run
      #     -e DIR=Weight-Loss-Trends
      #     -e TOKEN=${{secrets.TOKEN}}
      #     -e SECRET=${{secrets.SECRET}}
      #     -v "$(pwd)"/:/workdir
      #     shiny-push:latest
      #     Rscript -e "library(rsconnect); print(.libPaths())"

      # - name: Deploy With rsconnect
      #   if: github.ref == 'refs/heads/main'
      #   run: >
      #     docker run
      #     -e DIR=Weight-Loss-Trends
      #     -e TOKEN=${{secrets.TOKEN}}
      #     -e SECRET=${{secrets.SECRET}}
      #     -v "$(pwd)"/:/workdir
      #     shiny-push:latest
      #     Rscript deploy.R
